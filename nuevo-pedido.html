<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <title>Entregas Ya</title>

    <link rel="import" href="layout.html">
    <link rel="stylesheet" href="css/styles_np.css">

    <!-- include jQuery -->
    <script src="/lib/jquery-3.1.1.min.js"></script>

    <!-- include leaflet -->
    <link rel="stylesheet" href="./lib/leaflet/leaflet.css" />
    <script src="./lib/leaflet/leaflet.js"></script>

    <script src="js/myJS/myConfig.js"></script>
    <script src="js/mapCreation.js"></script>
    <script src="js/myJS/drawer.js"></script>

    <script src="js/entities/Driver.js"></script>
    <script src="js/entities/Tracker.js"></script>

    <style>
        span {
            color: red;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div id="nav-placeholder"></div>

    <!-- Content -->
    <div id="content">
        <div class="form-title">
            <h3>Solicitar pedido</h3>
        </div>
            
        <!-- <form> -->
            <!--Pedido de direcciones-->
            <div class="form-group">
                <div class="title">
                    <h3>Dirección</h3>
                </div>
   
                <label for="">Direccion Origen</label>
                <input id="Origen" class="form-control" autocomplete="off" placeholder="Loria 300, Lomas" value="Loria 300, Lomas">
                <span id="error-Origen"></span>
                <button type="submit" class="btn btn-primary" onclick="normalizar('Origen')">Validar</button>
                
                <br>       
                
                <div>
                    <select name="DirectionsList" id="DirectionsListOrigen"></select>
                </div>
                
                <label for="">Direccion Destino</label>
                <input id="Destino" class="form-control" autocomplete="off" placeholder="Loria 300, Lomas"/>
                <span id="error-Destino"></span>
                <button type="submit" class="btn btn-primary" onclick="normalizar('Destino')">Validar</button>

                <div>
                    <select name="DirectionsList" id="DirectionsListDestino"></select>
                </div>
            </div> <!--Pedido de direcciones-->

            <!--Pedir datos de paquete-->
            <div class="form-group">
                <div class="title">
                    <h3>Datos de paquete</h3>
                </div>
            
                <label for="">Tipo</label>
                <input class="form-control" autocomplete="off"/>

                <label for="">Tamaño</label>
                <input class="form-control" autocomplete="off"/>
                      
                <label for=""> Peso</label>
                <input class="form-control" autocomplete="off"/>             
            </div> <!--Pedir datos de paquete-->

            <!--Seleccionar repartidor-->
            <div class="form-group">
                <div class="title">
                    <h3>Seleccionar repartidor</h3>
                </div>

                <div>
                    <label for="">Cantidad de viajes</label>
                    <select class="form-control">
                        <option selected>Cantidad de viajes</option>
                        <option value="1">menos de 50</option>
                        <option value="2">mas de 50</option>
                    </select>    

                    <label for="">Tipo de vehiculo</label>
                    <select class="form-control">
                        <option selected>Tipo de vehiculo</option>
                        <option value="1">Camioneta</option>
                        <option value="2">Automovil</option>
                        <option value="3">Bici</option>
                        <option value="4">Otros</option>
                    </select>

                    <label for="">Tiempo estimado de espera</label>
                    <select class="form-control">
                        <option selected>Tiempo estimado de espera</option>
                        <option value="1"> 1 - 30 min</option>
                        <option value="2">30 - 60 min</option>
                        <option value="3">más de 1 hora</option>
                    </select>

                    <div class="listar-repartidores">
                        <button class="btn btn-primary" onclick="obtenerRepartidoresDisponibles();">
                            Listar Repartidores
                        </button>
                    </div>
                </div>

                <div id="map" style="width: 740px; height: 400px; background: #CCC;"></div>
                
            </div> <!--Seleccionar repartidor-->

            <div class="form-button">
                <button type="submit" class="btn btn-primary">Crear pedido</button>
            </div>

        <!-- </form> -->
    </div> <!-- Formulario -->

    <footer class="pie-pagina">
        <div class="barra">

        </div>
    </footer>

    <script>
        urlNormalizador = Config.urlNormalizador;
        urlEntregasYa = Config.urlEntregasYa;
        urlRepartidores = '/deliverydrivers/';
        urlPosiciones = '/positions/';

        // Mapa

        map = createMap('map');

        var drawer = new Drawer();

        // Direcciones

        function normalizar(id) {
            address = document.getElementById(id).value;
            requestAddress(address)
                .then(response => checkAddress(response, id))
                .then(extractAddress)
                .then(address => populateAddressList(address, id));
        }

        var requestAddress = function (address) {
            return $.ajax(urlNormalizador + address);
        }

        var checkAddress = function (response, id) {
            errorMessage = response['errorMessage'] ? response['errorMessage'] : '';
            document.getElementById('error-'+id).innerHTML = errorMessage;
            return response;
        }

        var populateAddressList = function (address, id) {
            console.log('Generando Listado de Direcciones...');

            list = $('#DirectionsList'+id);
            list.empty();

            address.forEach(direction => {
                option = document.createElement('option');
                option.value = option.textContent = direction.direccion;
                list.append(option);
            });
        }
        
        var extractAddress = function (response) {
            return responseExtract('direccionesNormalizadas', response);
        }

        // Repartidores

        function obtenerRepartidoresDisponibles() {
            tracker = new Tracker(map);
            // Old
            // requestDrivers()
            //     .then(extractDriver)
            //     .then(function (drivers) {
            //         drivers.forEach(driver => {
            //             resolverPosiciones(driver)
            //                 .then(drawDriver);
            //         });
            //     });

            // No funciona como se espera
            // requestDrivers()
            //     .then(extractDriver)
            //     .then(function (drivers) {
            //         drivers.forEach(driver => {
            //             resolverPosiciones(driver)
            //                 .then(function (driver) {
            //                     driver = new Driver(driver);
            //                     tracker.addDriver(driver);
            //                     // tracker.start();
            //                     console.log(`Driver ${driver.id} added.`);

            //                 })
            //         });
            //     })
            //     .then(function() {
            //         console.log('Fin.');
            //         // console.log(tracker.driversData);
            //         tracker.start();
            //     });

            // New
            requestDrivers()
                .then(extractDriver)
                .then(function (drivers) {
                    drivers.forEach(driver => {
                        resolverPosiciones(driver)
                            .then(function (driver) {
                                driver = new Driver(driver);
                                tracker.addDriver(driver);
                                console.log(`Driver ${driver.id} added.`);
                            });
                    });
                });
        }

        var drawDriver = function (driver) {
            drawer.drawDriverInMap(driver, map);
        }
        
        function requestDrivers(driver_id) {
            driver_id = driver_id ? driver_id : '';
            return $.ajax(urlEntregasYa + urlRepartidores + driver_id);
        }

        var requestPosiciones = function (driver_id) {
            return $.ajax(urlEntregasYa + urlRepartidores + driver_id + urlPosiciones);
        }
        
        var extractDriver = function (response) {
            return responseExtract('drivers', response);
        }

        var extractPosiciones = function (response) {
            return responseExtract('positions', response);
        }

        var resolverPosiciones = function (driver) {
            return requestPosiciones(driver.id)
                    .then(function (response) {
                        driver.positions = extractPosiciones(response);
                        return driver;
                    });
        }

        // Métodos útiles
        
        var responseExtract = function(attr, response) {
            console.log(response);
            return response[attr]
        }

        function log(response) {
            ret = response.errorMessage ? response.errorMessage : response;
            console.log(ret);
        }

        </script>

</body>
</html>